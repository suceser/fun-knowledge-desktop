# 趣知桌面版 - 部署分发

<div align="center">
  <h1>📦 趣知桌面版部署分发</h1>
  <p>应用打包、分发与自动更新策略</p>
</div>

---

## 📖 目录

1. [构建配置](#1-构建配置)
2. [打包策略](#2-打包策略)
3. [自动更新](#3-自动更新)
4. [CI/CD流水线](#4-cicd流水线)
5. [发布流程](#5-发布流程)
6. [版本管理](#6-版本管理)

---

## 1. 构建配置

### 1.1 Electron Builder配置

#### package.json构建配置

```json
{
  "name": "fun-knowledge-desktop",
  "productName": "趣知桌面版",
  "version": "1.0.0",
  "description": "现代化桌面知识管理应用",
  "author": "FunKnowledge Team",
  "build": {
    "appId": "com.funknowledge.desktop",
    "productName": "趣知桌面版",
    "asar": true,
    "asarUnpack": [
      "**/*.node",
      "**/node_modules/sharp/**/*"
    ],
    "files": [
      "dist/**/*",
      "node_modules/**/*",
      "package.json"
    ],
    "directories": {
      "buildResources": "assets",
      "output": "release/build"
    },
    "extraResources": [
      {
        "from": "assets/",
        "to": "assets/",
        "filter": ["**/*"]
      }
    ],
    "mac": {
      "target": [
        {
          "target": "dmg",
          "arch": ["arm64", "x64"]
        },
        {
          "target": "zip",
          "arch": ["arm64", "x64"]
        }
      ],
      "category": "public.app-category.productivity",
      "icon": "assets/icon.icns",
      "hardenedRuntime": true,
      "gatekeeperAssess": false,
      "entitlements": "build/entitlements.mac.plist",
      "entitlementsInherit": "build/entitlements.mac.plist",
      "notarize": {
        "teamId": "YOUR_TEAM_ID"
      }
    },
    "dmg": {
      "contents": [
        {
          "x": 130,
          "y": 220
        },
        {
          "x": 410,
          "y": 220,
          "type": "link",
          "path": "/Applications"
        }
      ],
      "window": {
        "width": 540,
        "height": 380
      }
    },
    "win": {
      "target": [
        {
          "target": "nsis",
          "arch": ["x64", "ia32"]
        },
        {
          "target": "portable",
          "arch": ["x64"]
        },
        {
          "target": "zip",
          "arch": ["x64"]
        }
      ],
      "icon": "assets/icon.ico",
      "publisherName": "FunKnowledge Inc.",
      "verifyUpdateCodeSignature": false
    },
    "nsis": {
      "oneClick": false,
      "perMachine": false,
      "allowElevation": true,
      "allowToChangeInstallationDirectory": true,
      "createDesktopShortcut": true,
      "createStartMenuShortcut": true,
      "shortcutName": "趣知桌面版",
      "include": "build/installer.nsh",
      "installerIcon": "assets/icon.ico",
      "uninstallerIcon": "assets/icon.ico",
      "installerHeaderIcon": "assets/icon.ico",
      "deleteAppDataOnUninstall": false
    },
    "portable": {
      "artifactName": "${productName}-${version}-portable.${ext}"
    },
    "linux": {
      "target": [
        {
          "target": "AppImage",
          "arch": ["x64"]
        },
        {
          "target": "deb",
          "arch": ["x64"]
        },
        {
          "target": "rpm",
          "arch": ["x64"]
        }
      ],
      "icon": "assets/icons/",
      "category": "Office",
      "maintainer": "contact@funknowledge.com",
      "vendor": "FunKnowledge Inc.",
      "synopsis": "现代化桌面知识管理应用",
      "description": "通过AI技术和可视化设计，提供智能问答、知识图谱、文档管理等核心功能"
    },
    "appImage": {
      "license": "LICENSE"
    },
    "deb": {
      "depends": [
        "gconf2",
        "gconf-service",
        "libnotify4",
        "libappindicator1",
        "libxtst6",
        "libnss3"
      ]
    },
    "publish": [
      {
        "provider": "github",
        "owner": "funknowledge",
        "repo": "fun-knowledge-desktop"
      }
    ]
  }
}
```

#### macOS权限配置

```xml
<!-- build/entitlements.mac.plist -->
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
  <dict>
    <key>com.apple.security.cs.allow-unsigned-executable-memory</key>
    <true/>
    <key>com.apple.security.cs.allow-jit</key>
    <true/>
    <key>com.apple.security.network.client</key>
    <true/>
    <key>com.apple.security.network.server</key>
    <true/>
    <key>com.apple.security.files.user-selected.read-write</key>
    <true/>
  </dict>
</plist>
```

### 1.2 构建脚本

#### npm scripts配置

```json
{
  "scripts": {
    "dev": "concurrently \"npm run start:renderer\" \"npm run start:main\"",
    "start:renderer": "webpack serve --config webpack.renderer.dev.js",
    "start:main": "electron -r ts-node/register src/main.ts",
    
    "build": "npm run build:renderer && npm run build:main",
    "build:renderer": "webpack --config webpack.renderer.prod.js",
    "build:main": "webpack --config webpack.main.prod.js",
    
    "package": "npm run build && electron-builder build --publish never",
    "package:mac": "npm run build && electron-builder build --mac --publish never",
    "package:win": "npm run build && electron-builder build --win --publish never",
    "package:linux": "npm run build && electron-builder build --linux --publish never",
    
    "release": "npm run build && electron-builder build --publish always",
    "release:mac": "npm run build && electron-builder build --mac --publish always",
    "release:win": "npm run build && electron-builder build --win --publish always",
    "release:linux": "npm run build && electron-builder build --linux --publish always"
  }
}
```

#### 构建前置检查脚本

```javascript
// scripts/pre-build.js
const fs = require('fs');
const path = require('path');

function checkBuildRequirements() {
  console.log('检查构建环境...');

  // 检查Node版本
  const nodeVersion = process.version;
  const requiredVersion = 'v18.0.0';
  if (nodeVersion < requiredVersion) {
    console.error(`❌ Node版本过低，需要 ${requiredVersion} 或更高`);
    process.exit(1);
  }
  console.log(`✅ Node版本: ${nodeVersion}`);

  // 检查必需文件
  const requiredFiles = [
    'package.json',
    'webpack.main.prod.js',
    'webpack.renderer.prod.js',
    'assets/icon.icns',
    'assets/icon.ico'
  ];

  for (const file of requiredFiles) {
    if (!fs.existsSync(path.join(__dirname, '..', file))) {
      console.error(`❌ 缺少必需文件: ${file}`);
      process.exit(1);
    }
  }
  console.log('✅ 必需文件检查通过');

  // 检查环境变量
  if (process.env.NODE_ENV !== 'production') {
    console.warn('⚠️  NODE_ENV 未设置为 production');
  }

  console.log('✅ 构建环境检查通过\n');
}

checkBuildRequirements();
```

---

## 2. 打包策略

### 2.1 平台特定配置

#### macOS打包

```bash
# 构建macOS应用
npm run package:mac

# 输出文件
# - FunKnowledge-1.0.0-arm64.dmg (Apple Silicon)
# - FunKnowledge-1.0.0-x64.dmg (Intel)
# - FunKnowledge-1.0.0-arm64-mac.zip
# - FunKnowledge-1.0.0-mac.zip
```

**macOS特殊处理:**

1. **代码签名**
   ```bash
   # 开发者证书配置
   export CSC_LINK=/path/to/certificate.p12
   export CSC_KEY_PASSWORD=your_password
   ```

2. **公证化**
   ```bash
   # Apple公证配置
   export APPLE_ID=your@email.com
   export APPLE_ID_PASSWORD=@keychain:AC_PASSWORD
   export APPLE_TEAM_ID=TEAM_ID
   ```

3. **通用二进制**
   ```javascript
   // 同时支持Intel和Apple Silicon
   {
     "mac": {
       "target": {
         "target": "dmg",
         "arch": ["arm64", "x64", "universal"]
       }
     }
   }
   ```

#### Windows打包

```bash
# 构建Windows应用
npm run package:win

# 输出文件
# - FunKnowledge Setup 1.0.0.exe (NSIS安装包)
# - FunKnowledge 1.0.0.exe (便携版)
# - FunKnowledge-1.0.0-win.zip
```

**Windows特殊处理:**

1. **代码签名**
   ```bash
   # Windows证书配置
   export CSC_LINK=/path/to/certificate.pfx
   export CSC_KEY_PASSWORD=your_password
   ```

2. **安装程序自定义**
   ```nsis
   ; build/installer.nsh
   !macro customInstall
     ; 自定义安装逻辑
     WriteRegStr HKCU "Software\FunKnowledge" "InstallPath" $INSTDIR
   !macroend

   !macro customUnInstall
     ; 自定义卸载逻辑
     DeleteRegKey HKCU "Software\FunKnowledge"
   !macroend
   ```

#### Linux打包

```bash
# 构建Linux应用
npm run package:linux

# 输出文件
# - FunKnowledge-1.0.0.AppImage
# - fun-knowledge-desktop_1.0.0_amd64.deb
# - fun-knowledge-desktop-1.0.0.x86_64.rpm
```

**Linux特殊处理:**

1. **依赖管理**
   ```json
   {
     "deb": {
       "depends": [
         "gconf2",
         "gconf-service",
         "libnotify4"
       ]
     }
   }
   ```

2. **桌面集成**
   ```desktop
   [Desktop Entry]
   Name=趣知桌面版
   Comment=现代化桌面知识管理应用
   Exec=AppRun
   Icon=fun-knowledge-desktop
   Type=Application
   Categories=Office;Utility;
   ```

### 2.2 资源优化

#### 代码压缩

```javascript
// webpack.main.prod.js
const TerserPlugin = require('terser-webpack-plugin');

module.exports = {
  mode: 'production',
  optimization: {
    minimize: true,
    minimizer: [
      new TerserPlugin({
        parallel: true,
        terserOptions: {
          compress: {
            drop_console: true,
            drop_debugger: true
          }
        }
      })
    ]
  }
};
```

#### ASAR打包

```javascript
// 排除不需要打包的文件
{
  "build": {
    "asar": true,
    "asarUnpack": [
      "**/*.node",
      "**/node_modules/sharp/**/*"
    ]
  }
}
```

#### 依赖优化

```bash
# 只打包生产依赖
npm prune --production

# 使用webpack externals
externals: {
  electron: 'commonjs2 electron'
}
```

---

## 3. 自动更新

### 3.1 更新机制

#### electron-updater配置

```typescript
// src/main/services/UpdateService.ts
import { autoUpdater } from 'electron-updater';
import { app, dialog, BrowserWindow } from 'electron';
import log from 'electron-log';

export class UpdateService {
  private mainWindow: BrowserWindow | null;

  constructor(mainWindow: BrowserWindow) {
    this.mainWindow = mainWindow;
    this.setupAutoUpdater();
  }

  private setupAutoUpdater() {
    // 配置更新服务器
    autoUpdater.setFeedURL({
      provider: 'github',
      owner: 'funknowledge',
      repo: 'fun-knowledge-desktop'
    });

    // 配置日志
    autoUpdater.logger = log;
    autoUpdater.autoDownload = false;
    autoUpdater.autoInstallOnAppQuit = true;

    // 监听更新事件
    this.registerUpdateHandlers();
  }

  private registerUpdateHandlers() {
    // 检查更新中
    autoUpdater.on('checking-for-update', () => {
      log.info('检查更新中...');
      this.sendStatusToWindow('checking-for-update');
    });

    // 发现新版本
    autoUpdater.on('update-available', (info) => {
      log.info('发现新版本:', info.version);
      this.showUpdateDialog(info);
    });

    // 当前已是最新版本
    autoUpdater.on('update-not-available', (info) => {
      log.info('当前已是最新版本');
      this.sendStatusToWindow('update-not-available');
    });

    // 下载进度
    autoUpdater.on('download-progress', (progressObj) => {
      let logMessage = `下载速度: ${progressObj.bytesPerSecond}`;
      logMessage += ` - 已下载 ${progressObj.percent}%`;
      logMessage += ` (${progressObj.transferred}/${progressObj.total})`;
      log.info(logMessage);
      
      this.sendStatusToWindow('download-progress', progressObj);
    });

    // 下载完成
    autoUpdater.on('update-downloaded', (info) => {
      log.info('更新下载完成');
      this.showRestartDialog(info);
    });

    // 更新错误
    autoUpdater.on('error', (error) => {
      log.error('更新错误:', error);
      this.sendStatusToWindow('update-error', error);
    });
  }

  private showUpdateDialog(updateInfo: any) {
    if (!this.mainWindow) return;

    dialog.showMessageBox(this.mainWindow, {
      type: 'info',
      title: '发现新版本',
      message: `发现新版本 ${updateInfo.version}`,
      detail: updateInfo.releaseNotes,
      buttons: ['立即更新', '稍后提醒'],
      defaultId: 0,
      cancelId: 1
    }).then(result => {
      if (result.response === 0) {
        autoUpdater.downloadUpdate();
        this.showDownloadingDialog();
      }
    });
  }

  private showDownloadingDialog() {
    if (!this.mainWindow) return;

    dialog.showMessageBox(this.mainWindow, {
      type: 'info',
      title: '下载更新',
      message: '正在下载更新，请稍候...',
      buttons: []
    });
  }

  private showRestartDialog(updateInfo: any) {
    if (!this.mainWindow) return;

    dialog.showMessageBox(this.mainWindow, {
      type: 'info',
      title: '更新已下载',
      message: '更新已下载完成，是否立即重启应用？',
      buttons: ['立即重启', '稍后重启'],
      defaultId: 0,
      cancelId: 1
    }).then(result => {
      if (result.response === 0) {
        autoUpdater.quitAndInstall(false, true);
      }
    });
  }

  private sendStatusToWindow(event: string, data?: any) {
    if (this.mainWindow) {
      this.mainWindow.webContents.send('update-status', { event, data });
    }
  }

  public checkForUpdates() {
    if (app.isPackaged) {
      autoUpdater.checkForUpdates();
    } else {
      log.info('开发环境，跳过更新检查');
    }
  }

  public checkForUpdatesAndNotify() {
    if (app.isPackaged) {
      autoUpdater.checkForUpdatesAndNotify();
    }
  }
}
```

### 3.2 更新策略

#### 启动检查

```typescript
// src/main/main.ts
app.whenReady().then(() => {
  const mainWindow = createWindow();
  const updateService = new UpdateService(mainWindow);
  
  // 应用启动时检查更新
  setTimeout(() => {
    updateService.checkForUpdates();
  }, 3000); // 延迟3秒，避免影响启动速度
});
```

#### 定期检查

```typescript
// 每4小时检查一次更新
setInterval(() => {
  updateService.checkForUpdates();
}, 4 * 60 * 60 * 1000);
```

#### 手动检查

```typescript
// 用户手动触发更新检查
ipcMain.handle('check-for-updates', async () => {
  updateService.checkForUpdates();
});
```

### 3.3 版本发布

#### 发布到GitHub Releases

```yaml
# .github/workflows/release.yml
name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build and release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run release
```

---

## 4. CI/CD流水线

### 4.1 GitHub Actions配置

#### 持续集成

```yaml
# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linting
        run: npm run lint
      
      - name: Run type check
        run: npm run type-check
      
      - name: Run tests
        run: npm run test:coverage
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info

  build:
    needs: lint-and-test
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build application
        run: npm run build
      
      - name: Package application
        run: npm run package
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.os }}-build
          path: release/build/*
```

#### 持续部署

```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Download artifacts
        uses: actions/download-artifact@v3
      
      - name: Deploy to CDN
        run: |
          # 上传到CDN
          aws s3 sync release/build/ s3://your-bucket/releases/${{ github.ref_name }}/
      
      - name: Update release notes
        run: |
          # 更新发布说明
          gh release edit ${{ github.ref_name }} --notes-file CHANGELOG.md
```

### 4.2 本地构建流程

#### 构建脚本

```bash
#!/bin/bash
# scripts/build.sh

set -e

echo "🚀 开始构建应用..."

# 清理旧构建
echo "📦 清理旧构建..."
rm -rf dist release

# 安装依赖
echo "📥 安装依赖..."
npm ci

# 运行测试
echo "🧪 运行测试..."
npm run test

# 类型检查
echo "🔍 类型检查..."
npm run type-check

# 代码检查
echo "✨ 代码检查..."
npm run lint

# 构建应用
echo "🏗️  构建应用..."
npm run build

# 打包应用
echo "📦 打包应用..."
npm run package

echo "✅ 构建完成!"
echo "📍 输出目录: release/build/"
```

---

## 5. 发布流程

### 5.1 版本发布检查清单

#### 发布前检查

- [ ] 所有测试通过
- [ ] 代码审查完成
- [ ] 更新CHANGELOG.md
- [ ] 更新版本号
- [ ] 构建成功
- [ ] 功能测试通过
- [ ] 性能测试通过
- [ ] 安全扫描通过
- [ ] 文档更新完成

#### 发布步骤

```bash
# 1. 创建发布分支
git checkout -b release/v1.0.0

# 2. 更新版本号
npm version 1.0.0

# 3. 更新CHANGELOG
# 编辑 CHANGELOG.md

# 4. 提交变更
git add .
git commit -m "chore: release v1.0.0"

# 5. 合并到main
git checkout main
git merge release/v1.0.0

# 6. 创建标签
git tag -a v1.0.0 -m "Release v1.0.0"

# 7. 推送到远程
git push origin main
git push origin v1.0.0

# 8. GitHub Actions自动构建和发布
```

### 5.2 发布公告

#### 发布说明模板

```markdown
# 趣知桌面版 v1.0.0

## 🎉 新特性

- ✨ 支持多AI模型提供商
- ✨ 新增知识图谱可视化
- ✨ 改进的搜索体验

## 🐛 Bug修复

- 🐛 修复了聊天消息滚动问题
- 🐛 修复了设置保存失败的问题
- 🐛 修复了文档导入错误

## 💪 性能优化

- ⚡ 提升了应用启动速度30%
- ⚡ 优化了大数据量渲染性能
- ⚡ 减少了内存占用

## 📝 其他改进

- 📝 更新了用户文档
- 📝 改进了错误提示
- 📝 优化了UI交互

## 🔗 下载链接

- [macOS (Apple Silicon)](https://github.com/funknowledge/releases/download/v1.0.0/FunKnowledge-1.0.0-arm64.dmg)
- [macOS (Intel)](https://github.com/funknowledge/releases/download/v1.0.0/FunKnowledge-1.0.0-x64.dmg)
- [Windows (x64)](https://github.com/funknowledge/releases/download/v1.0.0/FunKnowledge-Setup-1.0.0.exe)
- [Linux (AppImage)](https://github.com/funknowledge/releases/download/v1.0.0/FunKnowledge-1.0.0.AppImage)
- [Linux (deb)](https://github.com/funknowledge/releases/download/v1.0.0/fun-knowledge-desktop_1.0.0_amd64.deb)

## 📊 完整变更日志

详见 [CHANGELOG.md](./CHANGELOG.md)
```

---

## 6. 版本管理

### 6.1 语义化版本

#### 版本号格式

```
主版本号.次版本号.修订号 (MAJOR.MINOR.PATCH)

例如: 1.2.3
- 1: 主版本号 (不兼容的API变更)
- 2: 次版本号 (向下兼容的功能新增)
- 3: 修订号 (向下兼容的问题修正)
```

#### 版本策略

| 类型 | 说明 | 示例 |
|------|------|------|
| 主版本 | 重大变更，可能不兼容 | 1.0.0 → 2.0.0 |
| 次版本 | 新功能，向下兼容 | 1.0.0 → 1.1.0 |
| 修订版 | Bug修复 | 1.0.0 → 1.0.1 |
| 预发布 | Alpha/Beta/RC | 1.0.0-beta.1 |

### 6.2 变更日志

#### CHANGELOG.md模板

```markdown
# 变更日志

所有重要变更都将记录在此文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
版本号遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

## [Unreleased]

### Added
- 待发布的新功能

### Changed
- 待发布的变更

### Fixed
- 待发布的修复

## [1.0.0] - 2024-04-30

### Added
- ✨ 多AI模型支持
- ✨ 知识图谱可视化
- ✨ 完整的设置系统
- ✨ 本地数据持久化

### Changed
- 🎨 改进了UI设计
- ♻️ 重构了AI服务模块

### Fixed
- 🐛 修复了内存泄漏问题
- 🐛 修复了IPC通信错误

## [0.9.0] - 2024-03-31

### Added
- ✨ 基础AI问答功能
- ✨ 笔记编辑器
- ✨ 助手管理系统

### Changed
- 🎨 更新了主题样式

### Fixed
- 🐛 修复了启动崩溃问题
```

### 6.3 发布渠道

#### 稳定版（Stable）

- 面向所有用户
- 充分测试，稳定可靠
- 发布周期：2-3个月

#### 测试版（Beta）

- 面向早期用户
- 包含新功能，可能不稳定
- 发布周期：2-4周

#### 开发版（Nightly）

- 面向开发者和测试者
- 最新代码，可能有bug
- 发布周期：每日构建

---

## 📝 总结

### 🎯 部署分发核心

1. **多平台支持**: macOS、Windows、Linux完整支持
2. **自动更新**: 无缝的自动更新体验
3. **CI/CD**: 自动化构建和发布流程
4. **版本管理**: 规范的版本和变更管理

### 📈 最佳实践

- **代码签名**: 所有平台都进行代码签名
- **增量更新**: 使用差分更新减少下载量
- **灰度发布**: 逐步推送新版本
- **回滚机制**: 支持快速回滚到稳定版本

### 🎖️ 质量保障

- 发布前充分测试
- 多平台兼容性验证
- 性能和安全审计
- 用户反馈快速响应

通过完善的部署分发体系，确保用户能够方便、安全地获取和更新应用。

---

*本文档将随着项目发展持续更新和完善。*
*最后更新: 2025-10-19*

