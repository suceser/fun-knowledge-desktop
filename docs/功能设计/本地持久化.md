# 本地持久化方案文档

## 概述

本应用使用 `electron-store` 实现应用配置的本地持久化存储。该方案提供了主进程和渲染进程之间安全的配置管理接口。

## 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                        渲染进程                              │
│                                                              │
│  ┌──────────────┐      ┌─────────────────┐                 │
│  │  React组件   │ ───> │  useStorage     │                 │
│  └──────────────┘      │  Hooks          │                 │
│                        └─────────────────┘                 │
│                               │                              │
│                               ▼                              │
│                   ┌──────────────────────┐                  │
│                   │  storageService      │                  │
│                   │  (渲染进程)          │                  │
│                   └──────────────────────┘                  │
│                               │                              │
└───────────────────────────────┼──────────────────────────────┘
                                │ IPC
                                │ (contextBridge)
┌───────────────────────────────┼──────────────────────────────┐
│                               ▼                              │
│                   ┌──────────────────────┐                  │
│                   │  IPC Handlers        │                  │
│                   └──────────────────────┘                  │
│                               │                              │
│                               ▼                              │
│                   ┌──────────────────────┐                  │
│                   │  storageService      │                  │
│                   │  (主进程)            │                  │
│                   └──────────────────────┘                  │
│                               │                              │
│                               ▼                              │
│                   ┌──────────────────────┐                  │
│                   │  electron-store      │                  │
│                   └──────────────────────┘                  │
│                               │                              │
│                        主进程                                │
└───────────────────────────────┼──────────────────────────────┘
                                │
                                ▼
                    ┌──────────────────────┐
                    │  app-config.json     │
                    │  (用户数据目录)      │
                    └──────────────────────┘
```

## 存储位置

配置文件存储在系统用户数据目录：

- **Windows**: `%APPDATA%/fun-knowledge-desktop/app-config.json`
- **macOS**: `~/Library/Application Support/fun-knowledge-desktop/app-config.json`
- **Linux**: `~/.config/fun-knowledge-desktop/app-config.json`

## 配置结构

```typescript
interface AppConfig {
  general: GeneralSettings;      // 通用设置
  display: DisplaySettings;       // 显示设置
  models: ModelSettings;          // 模型设置
  search: SearchSettings;         // 搜索设置
  shortcuts: ShortcutSettings;    // 快捷键设置
  document: DocumentSettings;     // 文档设置
  data: DataSettings;             // 数据设置
  mcp: MCPSettings;               // MCP设置
  memory: MemorySettings;         // 记忆设置
}
```

详细类型定义请参考 `src/types/storage.ts`

## API 使用指南

### 1. 在 React 组件中使用 Hooks（推荐）

#### 基本用法

```tsx
import { useStorageValue } from '@/renderer/hooks/useStorage';

function MyComponent() {
  const [theme, setTheme, loading, error] = useStorageValue('general.theme', 'light');

  const handleChangeTheme = async () => {
    await setTheme('dark');
  };

  if (loading) return <div>加载中...</div>;
  if (error) return <div>错误: {error}</div>;

  return (
    <div>
      <p>当前主题: {theme}</p>
      <button onClick={handleChangeTheme}>切换主题</button>
    </div>
  );
}
```

#### 使用特定设置的 Hook

```tsx
import { 
  useGeneralSettings,
  useDisplaySettings,
  useModelSettings 
} from '@/renderer/hooks/useStorage';

function SettingsPage() {
  const [general, setGeneral] = useGeneralSettings();
  const [display, setDisplay] = useDisplaySettings();
  const [models, setModels] = useModelSettings();

  const handleUpdateLanguage = async () => {
    await setGeneral({ ...general, language: 'en-US' });
  };

  return <div>...</div>;
}
```

#### 获取所有配置

```tsx
import { useAllConfig } from '@/renderer/hooks/useStorage';

function ExportSettings() {
  const [config, updateConfig, loading, error] = useAllConfig();

  const handleExport = () => {
    console.log('所有配置:', config);
  };

  return <button onClick={handleExport}>导出配置</button>;
}
```

### 2. 直接使用服务（高级用法）

```tsx
import { storageService } from '@/renderer/services/storageService';

// 获取配置
const theme = await storageService.get<string>('general.theme');

// 设置配置
await storageService.set('general.theme', 'dark');

// 获取所有配置
const config = await storageService.getAll();

// 设置多个配置
await storageService.setMultiple({
  general: { theme: 'dark', language: 'zh-CN' },
  display: { fontSize: 16 }
});

// 删除配置项
await storageService.delete('general.theme');

// 检查配置项是否存在
const exists = await storageService.has('general.theme');

// 重置到默认配置
await storageService.reset();

// 导出配置
const json = await storageService.export();

// 导入配置
await storageService.import(json);

// 获取存储路径
const path = await storageService.getStorePath();

// 获取存储大小
const size = await storageService.getStoreSize();
```

### 3. 在主进程中使用

```typescript
import { storageService } from './services/storageService';

// 获取配置
const theme = storageService.get('general.theme');

// 设置配置
storageService.set('general.theme', 'dark');

// 监听配置变化
const unwatch = storageService.watch('general.theme', (newValue, oldValue) => {
  console.log('主题变化:', oldValue, '->', newValue);
});

// 取消监听
unwatch();
```

## 实际使用示例

### 示例 1: 主题切换

```tsx
import React from 'react';
import { useStorageValue } from '@/renderer/hooks/useStorage';
import { Switch } from 'antd';

function ThemeToggle() {
  const [theme, setTheme] = useStorageValue('general.theme', 'light');

  const handleToggle = async (checked: boolean) => {
    const newTheme = checked ? 'dark' : 'light';
    await setTheme(newTheme);
    
    // 应用主题
    document.documentElement.setAttribute('data-theme', newTheme);
  };

  return (
    <div>
      <label>深色模式</label>
      <Switch 
        checked={theme === 'dark'} 
        onChange={handleToggle}
      />
    </div>
  );
}
```

### 示例 2: 模型设置

```tsx
import React from 'react';
import { useModelSettings } from '@/renderer/hooks/useStorage';
import { Select, Input, Button } from 'antd';

function ModelSettings() {
  const [settings, setSettings, loading] = useModelSettings();

  const handleUpdateProvider = async (providerId: string) => {
    await setSettings({
      ...settings,
      defaultProvider: providerId
    });
  };

  const handleUpdateApiKey = async (key: string) => {
    const providers = { ...settings?.providers };
    providers[settings?.defaultProvider].apiKey = key;
    
    await setSettings({
      ...settings,
      providers
    });
  };

  if (loading) return <div>加载中...</div>;

  return (
    <div>
      <Select
        value={settings?.defaultProvider}
        onChange={handleUpdateProvider}
        options={[
          { label: 'OpenAI', value: 'openai' },
          { label: 'Anthropic', value: 'anthropic' }
        ]}
      />
      <Input.Password
        placeholder="API Key"
        onChange={(e) => handleUpdateApiKey(e.target.value)}
      />
    </div>
  );
}
```

### 示例 3: 导出/导入配置

```tsx
import React from 'react';
import { storageService } from '@/renderer/services/storageService';
import { Button, message } from 'antd';

function BackupSettings() {
  const handleExport = async () => {
    const json = await storageService.export();
    if (json) {
      // 下载为文件
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'app-config-backup.json';
      a.click();
      message.success('配置导出成功');
    }
  };

  const handleImport = async () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = async (e) => {
      const file = (e.target as HTMLInputElement).files?.[0];
      if (file) {
        const text = await file.text();
        const success = await storageService.import(text);
        if (success) {
          message.success('配置导入成功');
          window.location.reload();
        }
      }
    };
    input.click();
  };

  return (
    <div>
      <Button onClick={handleExport}>导出配置</Button>
      <Button onClick={handleImport}>导入配置</Button>
    </div>
  );
}
```

## 性能优化

### 1. 缓存机制

渲染进程的 `storageService` 内置了缓存机制：

```typescript
// 使用缓存（默认）
const value = await storageService.get('key', true);

// 跳过缓存，强制从主进程读取
const value = await storageService.get('key', false);

// 清除缓存
storageService.clearCache();
```

### 2. 批量更新

使用 `setMultiple` 减少 IPC 通信次数：

```typescript
// ❌ 不推荐：多次通信
await storageService.set('general.theme', 'dark');
await storageService.set('general.language', 'zh-CN');
await storageService.set('display.fontSize', 16);

// ✅ 推荐：一次通信
await storageService.setMultiple({
  general: { theme: 'dark', language: 'zh-CN' },
  display: { fontSize: 16 }
});
```

## 错误处理

所有异步操作都返回 `StorageResult` 类型：

```typescript
interface StorageResult<T> {
  success: boolean;
  data?: T;
  error?: string;
}
```

建议使用 try-catch 处理错误：

```typescript
try {
  const success = await storageService.set('key', 'value');
  if (!success) {
    message.error('保存失败');
  }
} catch (error) {
  console.error('存储错误:', error);
  message.error('操作失败');
}
```

## 安全性

1. **IPC 隔离**: 使用 `contextBridge` 安全地暴露 API
2. **类型安全**: 完整的 TypeScript 类型定义
3. **数据验证**: electron-store 支持 schema 验证（可扩展）
4. **文件权限**: 配置文件仅当前用户可读写

## 迁移指南

### 从 localStorage 迁移

```typescript
// 旧代码
const theme = localStorage.getItem('theme');
localStorage.setItem('theme', 'dark');

// 新代码
const theme = await storageService.get<string>('general.theme');
await storageService.set('general.theme', 'dark');
```

### 迁移现有数据

```typescript
// 一次性迁移脚本
async function migrateFromLocalStorage() {
  const oldTheme = localStorage.getItem('theme');
  const oldLanguage = localStorage.getItem('language');
  
  if (oldTheme || oldLanguage) {
    await storageService.setMultiple({
      general: {
        theme: oldTheme || 'light',
        language: oldLanguage || 'zh-CN'
      }
    });
    
    // 清除旧数据
    localStorage.removeItem('theme');
    localStorage.removeItem('language');
  }
}
```

## 测试

### 单元测试示例

```typescript
import { storageService } from '@/renderer/services/storageService';

describe('StorageService', () => {
  it('should get and set values', async () => {
    await storageService.set('test.key', 'value');
    const value = await storageService.get('test.key');
    expect(value).toBe('value');
  });

  it('should handle errors gracefully', async () => {
    const value = await storageService.get('nonexistent.key');
    expect(value).toBeUndefined();
  });
});
```

## 常见问题

### Q: 配置什么时候保存？
A: 调用 `set` 或 `setMultiple` 时立即保存到磁盘。

### Q: 如何重置所有配置？
A: 使用 `storageService.reset()` 重置到默认配置。

### Q: 配置文件损坏怎么办？
A: electron-store 会自动检测并清除无效配置，恢复默认值。

### Q: 可以存储敏感信息吗？
A: 可以，但建议使用 electron-store 的加密功能（需配置）。

### Q: 如何查看配置文件位置？
A: 使用 `storageService.getStorePath()` 获取完整路径。

## 未来优化

- [ ] 添加配置加密支持
- [ ] 实现配置版本控制
- [ ] 添加配置备份自动化
- [ ] 支持配置同步到云端
- [ ] 添加配置变更历史记录

## 参考资料

- [electron-store 官方文档](https://github.com/sindresorhus/electron-store)
- [Electron IPC 通信](https://www.electronjs.org/docs/latest/api/ipc-main)
- [Context Isolation](https://www.electronjs.org/docs/latest/tutorial/context-isolation)

